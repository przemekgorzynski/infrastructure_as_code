name: $(Build.Repository.Name) - $(Build.SourceBranchName)

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md

parameters:
  - name: Action
    displayName: Action
    type: string
    default: 'Plan'
    values:
    - Plan
    - Apply
    - Destroy

variables:
  - name: TargetSubscriptionID
    readonly: true
    value: 
  - name: ServicePrincipalID
    readonly: true
    value: 
  - name: ServicePrincipalKey
    readonly: true
    value: $(SP_KEY)
  - name: Tenant
    readonly: true
    value: 

stages:
  - stage: Plan
    condition: ne('${{ parameters.Action }}', 'Destroy')
    dependsOn: []
    pool: Azure Pipelines
    jobs:
      - job: Plan
        steps:
          - template: steps/init.yaml
            parameters:
              TargetSubscriptionID: ${{ variables.TargetSubscriptionID }}
              ServicePrincipalID: ${{ variables.ServicePrincipalID }}
              ServicePrincipalKey: ${{ variables.ServicePrincipalKey }}
              Tenant: ${{ variables.Tenant }}
          - template: steps/plan.yaml
            parameters:
              TargetSubscriptionID: ${{ variables.TargetSubscriptionID }}
              ServicePrincipalID: ${{ variables.ServicePrincipalID }}
              ServicePrincipalKey: ${{ variables.ServicePrincipalKey }}
              Tenant: ${{ variables.Tenant }}
  - stage: Apply
    condition: contains('${{ parameters.Action }}', 'Apply')
    dependsOn: Plan
    pool: Azure Pipelines
    jobs:
      - job: Apply
        steps:
          - template: steps/init.yaml
            parameters:
              TargetSubscriptionID: ${{ variables.TargetSubscriptionID }}
              ServicePrincipalID: ${{ variables.ServicePrincipalID }}
              ServicePrincipalKey: ${{ variables.ServicePrincipalKey }}
              Tenant: ${{ variables.Tenant }}
          - ${{ if eq(parameters.Action, 'Apply') }}:
            - template: steps/apply.yaml
              parameters:
                TargetSubscriptionID: ${{ variables.TargetSubscriptionID }}
                ServicePrincipalID: ${{ variables.ServicePrincipalID }}
                ServicePrincipalKey: ${{ variables.ServicePrincipalKey }}
                Tenant: ${{ variables.Tenant }}
  - stage: Destroy
    condition: contains('${{ parameters.Action }}', 'Destroy')
    dependsOn: []
    pool: Azure Pipelines
    jobs:
      - job: Destory
        steps:
          - template: steps/init.yaml
            parameters:
              TargetSubscriptionID: ${{ variables.TargetSubscriptionID }}
              ServicePrincipalID: ${{ variables.ServicePrincipalID }}
              ServicePrincipalKey: ${{ variables.ServicePrincipalKey }}
              Tenant: ${{ variables.Tenant }}
          - ${{ if eq(parameters.Action, 'Destroy') }}:
            - template: steps/destroy.yaml
              parameters:
                TargetSubscriptionID: ${{ variables.TargetSubscriptionID }}
                ServicePrincipalID: ${{ variables.ServicePrincipalID }}
                ServicePrincipalKey: ${{ variables.ServicePrincipalKey }}
                Tenant: ${{ variables.Tenant }}
